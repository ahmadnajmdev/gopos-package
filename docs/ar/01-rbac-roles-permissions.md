# التحكم بالوصول بناءً على الأدوار (RBAC)

## نظرة عامة

نظام RBAC يتحكم بـ **من يمكنه فعل ماذا** في GoPOS. بدلاً من إدارة الصلاحيات لكل مستخدم على حدة، تقوم بإنشاء أدوار (مثل "كاشير" أو "مدير") وتعيينها للمستخدمين. هذا يجعل إدارة الأمان بسيطة وقابلة للتوسع.

---

## لماذا تستخدم RBAC؟

### الفوائد الرئيسية

| الفائدة | كيف تساعد |
|---------|----------|
| **الأمان** | المستخدمون يرون فقط ما يحتاجونه - لا أكثر ولا أقل |
| **البساطة** | إدارة الأدوار مرة واحدة، تطبيقها على مستخدمين كثيرين |
| **الامتثال** | سجل تدقيق واضح لمن يمكنه الوصول لماذا |
| **المرونة** | إنشاء أدوار مخصصة لاحتياجات عملك الخاصة |
| **ثلاثي اللغات** | أسماء الأدوار بالإنجليزية والعربية والكردية |

### المشاكل التي يحلها

- **"الكاشيرات يرون بيانات المحاسبة"** - تقييد الوصول للوحدات حسب الدور
- **"الجميع لديه صلاحية المسؤول"** - إنشاء أدوار محدودة لكل وظيفة
- **"لا أستطيع تتبع من غير ماذا"** - الصلاحيات تخلق المساءلة
- **"إعداد موظف جديد يستغرق وقتاً طويلاً"** - عيّن دوراً وسيكون جاهزاً

---

## من يجب أن يقرأ هذا؟

| الدور | لماذا تقرأ هذا |
|-------|---------------|
| **مسؤولو النظام** | أنت تدير المستخدمين والأمان |
| **أصحاب الأعمال** | أنت تقرر من يصل لماذا |
| **موظفو تكنولوجيا المعلومات** | أنت تنفذ سياسات الأمان |
| **المطورون** | تحتاج للتحقق من الصلاحيات في الكود |

---

## حالات الاستخدام

### حالة الاستخدام 1: متجر تجزئة مع عدة كاشيرات

**السيناريو:** لديك 5 كاشيرات و 2 مديرين. الكاشيرات يجب أن يعالجوا المبيعات فقط، بينما المديرون يمكنهم إجراء المرتجعات ورؤية التقارير.

**الحل:**
1. استخدم دور `الكاشير` المدمج للكاشيرات (وصول نقطة البيع فقط)
2. استخدم دور `المدير` المدمج للمديرين (نقطة البيع + التقارير + محاسبة محدودة)
3. عيّن الأدوار عند إنشاء حسابات المستخدمين

**الفائدة:** الكاشيرات لا يستطيعون إلغاء المبيعات عن طريق الخطأ أو الوصول للتقارير الحساسة.

---

### حالة الاستخدام 2: وصول فريق المحاسبة

**السيناريو:** المحاسب يحتاج وصولاً كاملاً للبيانات المالية لكن لا يجب أن يعالج المبيعات أبداً.

**الحل:**
1. استخدم دور `المحاسب` المدمج
2. هذا الدور له وصول كامل للمحاسبة لكن بدون صلاحيات نقطة البيع

**الفائدة:** فصل المهام - المبيعات والمالية مستقلان.

---

### حالة الاستخدام 3: موظفو المستودع

**السيناريو:** عمال المستودع يحتاجون لإدارة المخزون لكن لا يجب أن يروا بيانات المبيعات أو المالية.

**الحل:**
1. استخدم دور `موظف المستودع` المدمج
2. هذا الدور يمكنه الوصول لوظائف المخزون فقط

**الفائدة:** عمليات المستودع لا تتداخل مع المبيعات أو المحاسبة.

---

### حالة الاستخدام 4: دور مخصص للمشرف

**السيناريو:** تحتاج مشرف وردية يمكنه إجراء المرتجعات لكن لا يرى التقارير.

**الحل:**
1. أنشئ دوراً مخصصاً جديداً "مشرف الوردية"
2. اختر فقط الصلاحيات المطلوبة: `pos.access`، `pos.sell`، `pos.refund`
3. عيّنه لمستخدمي المشرفين

**الفائدة:** تحكم دقيق في ما يمكن لكل منصب فعله بالضبط.

---

## الميزات

### الميزة 1: الأدوار الافتراضية

**ماذا تفعل:** GoPOS يأتي مع 7 أدوار مُعدة مسبقاً تغطي معظم احتياجات الأعمال.

**متى تستخدم:** استخدمها كما هي للإعدادات التجارية القياسية، أو كقوالب للأدوار المخصصة.

**الأدوار الافتراضية:**

| الدور | الأنسب لـ | ماذا يمكنهم فعله |
|-------|----------|-----------------|
| **المسؤول الأعلى** | أصحاب الأعمال، مسؤولو تكنولوجيا المعلومات | كل شيء - وصول كامل للنظام |
| **المدير** | مديرو المتاجر، المشرفون | نقطة البيع، المخزون، التقارير، محاسبة محدودة |
| **المحاسب** | موظفو المالية | وصول كامل للمحاسبة والمالية |
| **الكاشير** | موظفو المبيعات | عمليات نقطة البيع فقط |
| **موظف المستودع** | عمال المخزون | إدارة المخزون فقط |
| **مدير الموارد البشرية** | رؤساء قسم الموارد البشرية | وصول كامل للموارد البشرية |
| **موظف الموارد البشرية** | مساعدو الموارد البشرية | موارد بشرية محدودة (الحضور، الإجازات) |

**كيفية عرض الأدوار الافتراضية:**
1. انتقل إلى **الإعدادات > الأدوار**
2. اعرض جميع الأدوار مع عدد صلاحياتها
3. انقر على أي دور لرؤية صلاحياته

---

### الميزة 2: الصلاحيات حسب الوحدة

**ماذا تفعل:** الصلاحيات منظمة حسب الوحدة، مما يسهل منح الوصول لمناطق محددة.

**متى تستخدم:** عند إنشاء أدوار مخصصة أو مراجعة ما يمكن لكل دور فعله.

**الوحدات المتاحة:**

#### صلاحيات نقطة البيع
| الصلاحية | ماذا تسمح | الأدوار النموذجية |
|----------|----------|-------------------|
| `pos.access` | فتح واجهة نقطة البيع | الكاشير، المدير |
| `pos.sell` | معالجة المبيعات | الكاشير، المدير |
| `pos.refund` | معالجة المرتجعات | المدير |
| `pos.discount` | تطبيق الخصومات | المدير |
| `pos.hold` | تعليق/استدعاء المبيعات | الكاشير، المدير |
| `pos.reports` | عرض تقارير نقطة البيع | المدير |

#### صلاحيات المخزون
| الصلاحية | ماذا تسمح | الأدوار النموذجية |
|----------|----------|-------------------|
| `inventory.view` | عرض المخزون | موظف المستودع، المدير |
| `inventory.create` | إضافة المنتجات | موظف المستودع |
| `inventory.edit` | تعديل المنتجات | موظف المستودع |
| `inventory.delete` | حذف المنتجات | المدير |
| `inventory.adjust` | تعديل كميات المخزون | موظف المستودع |
| `inventory.transfer` | النقل بين المستودعات | موظف المستودع |

#### صلاحيات المبيعات
| الصلاحية | ماذا تسمح | الأدوار النموذجية |
|----------|----------|-------------------|
| `sales.view` | عرض سجل المبيعات | المدير، المحاسب |
| `sales.create` | إنشاء المبيعات | الكاشير، المدير |
| `sales.edit` | تعديل المبيعات | المدير |
| `sales.delete` | حذف المبيعات | المسؤول الأعلى |
| `sales.export` | تصدير بيانات المبيعات | المدير، المحاسب |

#### صلاحيات المشتريات
| الصلاحية | ماذا تسمح | الأدوار النموذجية |
|----------|----------|-------------------|
| `purchases.view` | عرض المشتريات | موظف المستودع، المدير |
| `purchases.create` | إنشاء أوامر الشراء | موظف المستودع |
| `purchases.edit` | تعديل المشتريات | المدير |
| `purchases.delete` | حذف المشتريات | المسؤول الأعلى |
| `purchases.approve` | الموافقة على المشتريات | المدير |

#### صلاحيات العملاء
| الصلاحية | ماذا تسمح | الأدوار النموذجية |
|----------|----------|-------------------|
| `customers.view` | عرض قائمة العملاء | الكاشير، المدير |
| `customers.create` | إضافة العملاء | الكاشير، المدير |
| `customers.edit` | تعديل معلومات العملاء | المدير |
| `customers.delete` | حذف العملاء | المدير |
| `customers.credit` | إدارة رصيد العملاء | المدير، المحاسب |

#### صلاحيات الموردين
| الصلاحية | ماذا تسمح | الأدوار النموذجية |
|----------|----------|-------------------|
| `suppliers.view` | عرض قائمة الموردين | موظف المستودع |
| `suppliers.create` | إضافة الموردين | المدير |
| `suppliers.edit` | تعديل الموردين | المدير |
| `suppliers.delete` | حذف الموردين | المسؤول الأعلى |

#### صلاحيات المحاسبة
| الصلاحية | ماذا تسمح | الأدوار النموذجية |
|----------|----------|-------------------|
| `accounting.view` | عرض بيانات المحاسبة | المحاسب |
| `accounting.entries` | إنشاء قيود اليومية | المحاسب |
| `accounting.approve` | الموافقة على القيود | المحاسب، المدير |
| `accounting.reports` | عرض التقارير المالية | المحاسب، المدير |
| `accounting.settings` | إدارة دليل الحسابات | المحاسب |
| `accounting.close_period` | إغلاق الفترات المالية | المحاسب |

#### صلاحيات الموارد البشرية
| الصلاحية | ماذا تسمح | الأدوار النموذجية |
|----------|----------|-------------------|
| `hr.view` | عرض بيانات الموارد البشرية | موظف الموارد البشرية، المدير |
| `hr.employees` | إدارة الموظفين | مدير الموارد البشرية |
| `hr.payroll` | معالجة الرواتب | مدير الموارد البشرية |
| `hr.attendance` | إدارة الحضور | موظف الموارد البشرية |
| `hr.leave` | إدارة طلبات الإجازات | موظف الموارد البشرية |
| `hr.reports` | عرض تقارير الموارد البشرية | مدير الموارد البشرية |

#### صلاحيات التقارير
| الصلاحية | ماذا تسمح | الأدوار النموذجية |
|----------|----------|-------------------|
| `reports.sales` | عرض تقارير المبيعات | المدير |
| `reports.purchases` | عرض تقارير المشتريات | المدير |
| `reports.inventory` | عرض تقارير المخزون | موظف المستودع، المدير |
| `reports.financial` | عرض التقارير المالية | المحاسب |
| `reports.hr` | عرض تقارير الموارد البشرية | مدير الموارد البشرية |
| `reports.export` | تصدير أي تقرير | المدير |

#### صلاحيات الإعدادات
| الصلاحية | ماذا تسمح | الأدوار النموذجية |
|----------|----------|-------------------|
| `settings.general` | الإعدادات العامة | المسؤول الأعلى |
| `settings.users` | إدارة المستخدمين | المسؤول الأعلى |
| `settings.roles` | إدارة الأدوار | المسؤول الأعلى |
| `settings.company` | إعدادات الشركة | المسؤول الأعلى |
| `settings.integrations` | إعدادات التكامل | المسؤول الأعلى |
| `settings.backup` | النسخ الاحتياطي والاستعادة | المسؤول الأعلى |

---

### الميزة 3: إنشاء أدوار مخصصة

**ماذا تفعل:** إنشاء أدوار مصممة خصيصاً لاحتياجات عملك.

**متى تستخدم:** عندما لا تتطابق الأدوار الافتراضية مع متطلباتك.

**كيفية إنشاء دور مخصص:**

1. انتقل إلى **الإعدادات > الأدوار**
2. انقر **إنشاء دور**
3. املأ التفاصيل:
   - **الاسم (الإنجليزية):** مطلوب - مثال: "Shift Supervisor"
   - **الاسم (العربية):** اختياري - مثال: "مشرف الوردية"
   - **الاسم (الكردية):** اختياري - مثال: "سەرپەرشتیاری شیفت"
   - **الوصف:** ما هو هذا الدور
4. حدد الصلاحيات التي يحتاجها هذا الدور (مجمعة حسب الوحدة)
5. انقر **إنشاء**

**مثال عملي:**

إنشاء دور "كاشير أقدم":
- يمكنه فعل كل ما يفعله الكاشير
- بالإضافة إلى: تطبيق الخصومات (`pos.discount`)
- بالإضافة إلى: عرض تقارير المبيعات اليومية (`reports.sales`)

---

### الميزة 4: تعيين الأدوار

**ماذا تفعل:** ربط المستخدمين بأدوارهم.

**متى تستخدم:** عند إنشاء مستخدمين جدد أو تغيير مسؤوليات شخص ما.

**كيفية تعيين الأدوار (عبر الواجهة):**

1. انتقل إلى **الإعدادات > المستخدمين**
2. أنشئ مستخدماً جديداً أو عدّل مستخدماً موجوداً
3. في قسم **الأدوار**، حدد دوراً أو أكثر
4. احفظ المستخدم

**كيفية تعيين الأدوار (عبر الكود):**

```php
use App\Models\User;
use App\Models\Role;

// احصل على المستخدم
$user = User::find(1);

// عيّن دوراً واحداً بالاسم
$user->assignRole('manager');

// عيّن أدواراً متعددة
$user->assignRole(['manager', 'accountant']);

// باستخدام نموذج الدور
$role = Role::findByName('cashier');
$user->assignRole($role);
```

**مثال عملي:**

أحمد يبدأ ككاشير، ثم يُرقّى:
1. في البداية: عيّن دور `الكاشير`
2. بعد الترقية: أضف دور `المدير` (لديه كلاهما الآن)
3. أو: احذف `الكاشير`، أضف `المدير` (استبدال الدور)

---

### الميزة 5: التحقق من الصلاحيات

**ماذا تفعل:** التحقق من أن المستخدمين لديهم الوصول المطلوب قبل السماح بالإجراءات.

**متى تستخدم:** في الكود، والقوالب، والميزات المخصصة.

**كيفية التحقق من الصلاحيات في PHP:**

```php
// تحقق إذا كان المستخدم لديه دور معين
if ($user->hasRole('manager')) {
    // اعرض ميزات المدير
}

// تحقق إذا كان المستخدم لديه أي من هذه الأدوار
if ($user->hasRole(['manager', 'accountant'])) {
    // اعرض الميزات للمديرين أو المحاسبين
}

// تحقق إذا كان المستخدم لديه صلاحية معينة
if ($user->hasPermission('pos.refund')) {
    // اعرض زر المرتجعات
}

// تحقق إذا كان المستخدم لديه كل هذه الصلاحيات
if ($user->hasAllPermissions(['pos.sell', 'pos.refund'])) {
    // المستخدم يمكنه البيع والإرجاع
}

// احصل على كل صلاحيات المستخدم
$permissions = $user->getAllPermissions();
```

**كيفية التحقق من الصلاحيات في قوالب Blade:**

```blade
@if(auth()->user()->hasRole('manager'))
    <a href="/reports">عرض التقارير</a>
@endif

@if(auth()->user()->hasPermission('pos.discount'))
    <button>تطبيق الخصم</button>
@endif
```

**كيفية التحقق في موارد Filament:**

```php
public static function canViewAny(): bool
{
    return auth()->user()->hasPermission('sales.view');
}

public static function canCreate(): bool
{
    return auth()->user()->hasPermission('sales.create');
}

public static function canEdit(Model $record): bool
{
    return auth()->user()->hasPermission('sales.edit');
}

public static function canDelete(Model $record): bool
{
    return auth()->user()->hasPermission('sales.delete');
}
```

---

## أفضل الممارسات

### افعل

| الممارسة | لماذا |
|----------|-------|
| ابدأ بالأدوار الافتراضية | تغطي معظم السيناريوهات الشائعة |
| استخدم أقل الامتيازات | أعطِ الحد الأدنى من الصلاحيات المطلوبة |
| راجع الأدوار ربع سنوياً | المسؤوليات الوظيفية تتغير |
| وثّق الأدوار المخصصة | ليفهم الآخرون غرضها |
| اختبر بعد التغييرات | تحقق من أن المستخدمين يمكنهم القيام بعملهم |

### لا تفعل

| تجنب | لماذا |
|------|-------|
| إعطاء الجميع صلاحية المسؤول الأعلى | يهزم غرض RBAC |
| أدوار مخصصة كثيرة جداً | صعبة الصيانة - استخدم الافتراضية عند الإمكان |
| زحف الصلاحيات | احذف الصلاحيات عندما لم تعد مطلوبة |
| مشاركة الحسابات | كل مستخدم يجب أن يكون له حسابه الخاص |

---

## المرجع التقني

### مرجع API

#### نموذج الدور

```php
use App\Models\Role;

// البحث بالاسم
$role = Role::findByName('manager');

// احصل على الاسم المترجم (بناءً على اللغة الحالية)
$name = $role->localizedName;

// احصل على كل الصلاحيات لهذا الدور
$permissions = $role->permissions;

// تحقق إذا كان دور النظام (لا يمكن حذفه)
if ($role->is_system) {
    // دور محمي
}
```

#### نموذج الصلاحية

```php
use App\Models\Permission;

// البحث بالاسم
$permission = Permission::findByName('pos.sell');

// احصل حسب الوحدة
$posPermissions = Permission::where('module', 'pos')->get();

// احصل على الاسم المترجم
$name = $permission->localizedName;
```

#### خدمة الصلاحيات

```php
use App\Services\PermissionService;

$service = new PermissionService();

// احصل على كل الصلاحيات مع الترجمات
$permissions = $service->getAllPermissions();

// بذر الصلاحيات (تشغيل مرة واحدة أثناء الإعداد)
$service->seedPermissions();

// بذر الأدوار الافتراضية
$service->seedDefaultRoles();
```

### مخطط قاعدة البيانات

#### جدول الأدوار

| العمود | النوع | الوصف |
|--------|------|-------|
| id | bigint | المفتاح الأساسي |
| name | string | كود الدور الفريد (مثل 'manager') |
| name_ar | string | اسم العرض بالعربية |
| name_ckb | string | اسم العرض بالكردية |
| description | text | وصف الدور |
| description_ar | text | الوصف بالعربية |
| description_ckb | text | الوصف بالكردية |
| is_system | boolean | إذا كان صحيحاً، لا يمكن حذفه |
| created_at | timestamp | متى تم إنشاؤه |
| updated_at | timestamp | آخر تعديل |

#### جدول الصلاحيات

| العمود | النوع | الوصف |
|--------|------|-------|
| id | bigint | المفتاح الأساسي |
| name | string | كود الصلاحية الفريد (مثل 'pos.sell') |
| name_ar | string | اسم العرض بالعربية |
| name_ckb | string | اسم العرض بالكردية |
| description | text | ما تسمح به هذه الصلاحية |
| description_ar | text | الوصف بالعربية |
| description_ckb | text | الوصف بالكردية |
| module | string | تجميع الوحدة (pos, sales, إلخ.) |
| created_at | timestamp | متى تم إنشاؤه |
| updated_at | timestamp | آخر تعديل |

#### جدول صلاحيات الأدوار

| العمود | النوع | الوصف |
|--------|------|-------|
| role_id | bigint | مفتاح خارجي للأدوار |
| permission_id | bigint | مفتاح خارجي للصلاحيات |

#### جدول أدوار النماذج

| العمود | النوع | الوصف |
|--------|------|-------|
| role_id | bigint | مفتاح خارجي للأدوار |
| model_type | string | دائماً 'App\Models\User' |
| model_id | bigint | معرف المستخدم |

---

## حل المشاكل

### المستخدم لديه دور لكن لا يستطيع الوصول للميزة

**المشكلة:** المستخدم مُعيّن له دور لكن لا يزال لا يستطيع رؤية/فعل شيء.

**الحلول:**
1. تحقق أن الدور لديه الصلاحية المطلوبة (الإعدادات > الأدوار > تعديل الدور)
2. تحقق إذا كان التحقق من الصلاحية منفذ بشكل صحيح في الكود
3. امسح ذاكرة التخزين المؤقت للتطبيق: `php artisan optimize:clear`
4. تأكد من تحديث جلسة المستخدم (تسجيل الخروج والدخول مرة أخرى)

---

### الصلاحية لا تظهر في القائمة

**المشكلة:** صلاحية تحتاجها غير موجودة.

**الحلول:**
1. شغّل بذار الصلاحيات:
   ```bash
   php artisan db:seed --class=RolesAndPermissionsSeeder
   ```
2. تحقق من `PermissionService` لتعريف الصلاحية
3. أضف الصلاحية إذا كانت لميزة مخصصة

---

### لا يمكن حذف دور

**المشكلة:** زر الحذف معطل أو الحذف يفشل.

**الحل:** الدور معلّم كدور نظام (`is_system = true`). أدوار النظام محمية ولا يمكن حذفها لمنع مشاكل الأمان العرضية.

**حل بديل:** عدّل الدور لإزالة الصلاحيات غير المرغوبة بدلاً من حذفه.

---

### تغييرات الصلاحيات لا تأخذ مفعولها

**المشكلة:** بعد تغيير صلاحيات الدور، لا يزال المستخدمون لديهم الوصول القديم.

**الحلول:**
1. امسح ذاكرة التخزين المؤقت: `php artisan optimize:clear`
2. اطلب من المستخدمين تسجيل الخروج والدخول مرة أخرى
3. تحقق إذا كان المستخدم لديه أدوار متعددة (الصلاحيات تُجمع)

---

*آخر تحديث: يناير 2026*
