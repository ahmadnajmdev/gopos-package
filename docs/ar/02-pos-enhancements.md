# تحسينات وحدة نقطة البيع

## نظرة عامة

وحدة نقطة البيع (POS) هي قلب عمليات البيع بالتجزئة اليومية. تتعامل مع كل شيء من المبيعات البسيطة إلى السيناريوهات المعقدة مثل الدفع المقسم، برامج ولاء العملاء، وإدارة الورديات مع تتبع النقد.

---

## لماذا تستخدم هذه الميزات؟

### الفوائد الرئيسية

| الفائدة | كيف تساعد عملك |
|---------|---------------|
| **مساءلة النقد** | إدارة الورديات تتتبع كل دينار - اعرف بالضبط أين يذهب المال |
| **مرونة الدفع** | اقبل طرق دفع متعددة في معاملة واحدة |
| **الاحتفاظ بالعملاء** | برامج الولاء تعيد العملاء |
| **كفاءة سير العمل** | تعليق/استدعاء المبيعات يمنع ضياع المعاملات |
| **إيصالات احترافية** | صيغ طباعة متعددة لأي طابعة |

### المشاكل التي تحلها

- **"النقد دائماً ناقص في نهاية اليوم"** - تتبع الورديات مع تقارير الفروقات
- **"العميل يريد أن يدفع نصف نقداً ونصف بالبطاقة"** - دعم الدفع المقسم
- **"نخسر العملاء المتكررين"** - نقاط الولاء تشجع على العودة
- **"العميل نسي محفظته، خسرنا البيع"** - علّق البيع حتى يعود
- **"إيصالاتنا تبدو غير احترافية"** - صيغ إيصالات قابلة للتخصيص

---

## من يجب أن يقرأ هذا؟

| الدور | الأقسام ذات الصلة |
|-------|------------------|
| **الكاشيرات** | إدارة الورديات، الدفع المقسم، التعليق/الاستدعاء |
| **مديرو المتاجر** | جميع الأقسام - خاصة تقارير الورديات |
| **أصحاب الأعمال** | برنامج الولاء، تقارير الورديات |
| **المطورون** | جميع الأقسام للتكامل |

---

## مكونات الوحدة

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      تحسينات نقطة البيع                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌───────────────────┐   تتبع النقد، منع السرقة، المساءلة               │
│  │  إدارة الورديات   │   استخدم عند: بداية/نهاية يوم العمل              │
│  └───────────────────┘                                                  │
│                                                                         │
│  ┌───────────────────┐   طرق دفع متعددة في بيع واحد                     │
│  │   الدفع المقسم    │   استخدم عند: العميل يدفع نقداً + بطاقة          │
│  └───────────────────┘                                                  │
│                                                                         │
│  ┌───────────────────┐   مكافأة العملاء المتكررين، زيادة الولاء         │
│  │  برنامج الولاء    │   استخدم عند: بناء علاقات العملاء                │
│  └───────────────────┘                                                  │
│                                                                         │
│  ┌───────────────────┐   إيقاف المبيعات مؤقتاً، استكمالها لاحقاً        │
│  │ التعليق/الاستدعاء │   استخدم عند: العميل يغادر مؤقتاً                │
│  └───────────────────┘                                                  │
│                                                                         │
│  ┌───────────────────┐   إنشاء إيصالات لأي طابعة                        │
│  │  طباعة الإيصالات  │   استخدم عند: إتمام أي بيع                       │
│  └───────────────────┘                                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## الميزة 1: إدارة الورديات

### ما هي؟

إدارة الورديات تتتبع جلسة كل كاشير من البداية إلى النهاية. تسجل:
- مبلغ النقد الافتتاحي
- جميع المبيعات والمرتجعات خلال الوردية
- إضافات النقد (إيداعات النثرية)
- سحوبات النقد (فكة للفواتير الكبيرة)
- عد النقد الختامي وأي فروقات

### الفوائد الرئيسية

| الفائدة | الوصف |
|---------|-------|
| **مساءلة النقد** | اعرف بالضبط كم يجب أن يكون في الدرج |
| **منع السرقة** | الفروقات تظهر فوراً وموثقة |
| **تسليم سهل** | نقاط بداية/نهاية واضحة لتغيير الورديات |
| **سجل التدقيق** | تاريخ كامل لجميع حركات النقد |
| **تقارير Z** | تقارير ملخص نهاية الوردية |

### متى تستخدم

| السيناريو | الإجراء |
|----------|---------|
| بداية يوم عملك | افتح وردية جديدة |
| نهاية يوم عملك | أغلق الوردية |
| إضافة نثرية للدرج | سجل إدخال نقد |
| إخراج نقد للفكة | سجل إخراج نقد |
| التسليم للكاشير التالي | أغلق الوردية، يفتح هو وردية جديدة |
| المدير يراجع النشاط اليومي | عرض تقرير Z |

### حالة الاستخدام: العمليات اليومية للتجزئة

**السيناريو:** أحمد يبدأ ورديته الساعة 9 صباحاً مع 50,000 دينار في الدرج.

**الصباح:**
1. أحمد يفتح الوردية، يدخل 50,000 دينار نقد افتتاحي
2. يعالج المبيعات طوال الصباح
3. عند الظهر، يسجل إدخال نقد 10,000 دينار (إيداع نثرية)

**بعد الظهر:**
1. عميل يحتاج تبديل 20,000 دينار لفئات أصغر
2. أحمد يسجل هذا كإخراج نقد
3. يستمر في معالجة المبيعات

**نهاية الوردية:**
1. أحمد يعد النقد: 185,000 دينار
2. النظام حسب المتوقع: 180,000 دينار
3. أحمد لديه زيادة 5,000 دينار - يلاحظ "وجدت أوراق نقدية تحت الصندوق"
4. المدير يراجع تقرير Z ويوافق

### كيفية الاستخدام (خطوات الواجهة)

#### فتح وردية

1. انتقل إلى **المبيعات > إدارة الورديات** أو انقر أيقونة الوردية في نقطة البيع
2. انقر **فتح وردية**
3. أدخل مبلغ **النقد الافتتاحي** (عد ما في الدرج)
4. اختيارياً أدخل **معرف الطرفية** (مثل "POS-1"، "صندوق أ")
5. انقر **فتح الوردية**

> **مهم:** يمكنك فتح وردية واحدة فقط في كل مرة. فتح وردية جديدة يغلق أي وردية موجودة تلقائياً.

#### أثناء ورديتك

أثناء العمل:
- جميع المبيعات ترتبط تلقائياً بورديتك الحالية
- المعاملات النقدية تُتتبع في الوقت الفعلي
- عرض إجمالياتك الجارية في أي وقت في إدارة الورديات

#### تسجيل إدخال/إخراج النقد

لحركات النقد غير البيعية:

1. في إدارة الورديات، انقر **إدخال نقد** أو **إخراج نقد**
2. أدخل المبلغ
3. أضف ملاحظة توضح الحركة (مطلوبة لسجل التدقيق)
4. أكد المعاملة

**أمثلة:**
- إدخال نقد: "إيداع نثرية من المدير"
- إخراج نقد: "فكة لفاتورة 50,000"
- إخراج نقد: "دفع لعامل التوصيل"

#### إغلاق ورديتك

1. انتقل إلى **المبيعات > إدارة الورديات**
2. انقر **إغلاق الوردية**
3. عد النقد الفعلي بعناية
4. أدخل مبلغ **النقد المعدود**
5. النظام يعرض:
   - النقد المتوقع (محسوب من المعاملات)
   - الفرق (موجب = زيادة، سالب = نقص)
6. أضف ملاحظات توضح أي فرق
7. انقر **إغلاق الوردية**

#### عرض تقارير الوردية (تقرير Z)

1. في سجل الورديات، ابحث عن الوردية المطلوبة
2. انقر **عرض التقرير**
3. تقرير Z يعرض:
   - مدة الوردية (وقت البداية إلى النهاية)
   - ملخص النقد (افتتاحي ← ختامي)
   - تفصيل المبيعات حسب طريقة الدفع
   - المرتجعات المعالجة
   - إجمالي المعاملات ومتوسط قيمة البيع
4. انقر **طباعة التقرير** إذا لزم الأمر

### كيفية الاستخدام (الكود)

```php
use App\Services\POSSessionService;

$sessionService = app(POSSessionService::class);

// فتح وردية
$session = $sessionService->openSession(
    user: auth()->user(),
    openingCash: 50000,
    terminalId: 'POS-1'
);

// التحقق من وجود وردية مفتوحة للمستخدم
if ($sessionService->hasOpenSession()) {
    $currentSession = $sessionService->getCurrentSession();
}

// تسجيل حركات النقد
$sessionService->recordCashIn($session, 10000, 'إيداع نثرية');
$sessionService->recordCashOut($session, 5000, 'فكة للعميل');

// الحصول على الملخص في الوقت الفعلي
$summary = $sessionService->getSessionSummary($session);
// يعيد: total_sales, total_refunds, cash_in, cash_out, expected_cash

// إغلاق الوردية
$sessionService->closeSession(
    session: $session,
    closingCash: 125000,
    closedBy: auth()->user(),
    notes: 'كل شيء مطابق'
);

// الحصول على ملخص يوم معين
$dailySummary = $sessionService->getDailySummary(today());
```

### أفضل الممارسات

| افعل | لا تفعل |
|------|--------|
| عد النقد بعناية قبل الفتح | تخمين المبالغ الافتتاحية |
| وثق كل إدخال/إخراج بملاحظات | تحريك النقد بدون تسجيل |
| أغلق الوردية قبل المغادرة | ترك الورديات مفتوحة طوال الليل |
| اشرح أي فرق في الملاحظات | تجاهل الفروقات |
| حافظ على أمان منطقة الصندوق | ترك الدرج مفتوحاً |

---

## الميزة 2: الدفع المقسم

### ما هو؟

الدفع المقسم يسمح للعملاء بالدفع باستخدام طرق متعددة في معاملة واحدة. مثلاً، يمكن للعميل دفع 50,000 دينار نقداً والباقي 30,000 دينار بالبطاقة.

### الفوائد الرئيسية

| الفائدة | الوصف |
|---------|-------|
| **راحة العميل** | لا تخسر مبيعات عندما لا يملك العميل الدفع الكامل بطريقة واحدة |
| **المرونة** | اقبل أي مزيج من أنواع الدفع |
| **تتبع دقيق** | كل طريقة دفع تُتتبع بشكل منفصل |
| **حساب الباقي** | حساب تلقائي للباقي للأجزاء النقدية |

### متى تستخدم

| السيناريو | استخدم الدفع المقسم |
|----------|---------------------|
| العميل لا يملك نقداً كافياً | أضف دفع بطاقة للباقي |
| العميل يريد استخدام بطاقة هدايا + نقد | قسم بين كليهما |
| العميل لديه رصيد متجر | طبق الرصيد + اجمع المتبقي |
| حالات الدفع الجماعي | كل شخص يدفع حصته |

### حالة الاستخدام: دفع مختلط في مطعم

**السيناريو:** الفاتورة الإجمالية 80,000 دينار. العميل لديه 50,000 دينار نقداً ويريد دفع الباقي بالبطاقة.

**الحل:**
1. فعّل الدفع المقسم
2. أضف دفع نقدي: 50,000 دينار
3. أضف دفع بطاقة: 30,000 دينار
4. أكمل البيع
5. الإيصال يعرض طريقتي الدفع

### كيفية الاستخدام (خطوات الواجهة)

1. في نقطة البيع، أضف العناصر للسلة كالعادة
2. انقر **الدفع**
3. فعّل خيار **الدفع المقسم**
4. لكل دفعة:
   - اختر طريقة الدفع (نقد، بطاقة، تحويل بنكي، موبايل، رصيد)
   - أدخل المبلغ لهذه الدفعة
   - للنقد: أدخل المبلغ المستلم لحساب الباقي
   - انقر **إضافة الدفعة**
5. استمر حتى يُغطى الإجمالي (المتبقي يظهر 0)
6. انقر **إتمام البيع**

### طرق الدفع المتاحة

| الطريقة | الكود | الوصف | متى تستخدم |
|---------|-------|-------|-----------|
| نقد | `cash` | عملة فعلية | المدفوعات النقدية الشخصية |
| بطاقة | `card` | بطاقة ائتمان/خصم | مدفوعات البطاقة |
| تحويل بنكي | `bank_transfer` | تحويل بنكي مباشر | التحويلات المرتبة مسبقاً |
| دفع موبايل | `mobile_payment` | FIB، FastPay، إلخ. | مدفوعات المحفظة الإلكترونية |
| رصيد | `credit` | رصيد/حساب المتجر | العميل لديه رصيد |

### كيفية الاستخدام (الكود)

```php
use App\Services\SplitPaymentService;

$paymentService = app(SplitPaymentService::class);

// معالجة مدفوعات متعددة لبيع
$payments = $paymentService->processPayments($sale, [
    [
        'method' => 'cash',
        'amount' => 50000,
        'tendered' => 50000,
    ],
    [
        'method' => 'card',
        'amount' => 30000,
        'reference_number' => 'TXN123456',
    ],
], $currentSession);

// التحقق من المدفوعات قبل المعالجة
$errors = $paymentService->validatePayments($saleTotal, $payments);
if (!empty($errors)) {
    // التعامل مع أخطاء التحقق
}

// حساب الباقي للدفع النقدي
$change = $paymentService->calculateChange(
    tenderedAmount: 100000,
    dueAmount: 85000
); // يعيد 15000

// الحصول على تفصيل الدفع لبيع
$breakdown = $paymentService->getPaymentBreakdown($sale);
// يعيد: total_sale, total_paid, remaining, is_fully_paid, by_method

// إضافة دفعة إضافية لبيع موجود
$payment = $paymentService->addPayment($sale, [
    'method' => 'bank_transfer',
    'amount' => 20000,
    'reference_number' => 'TRANSFER-789',
]);

// إلغاء دفعة (مع السبب)
$paymentService->voidPayment($payment, $currentSession);
```

### أفضل الممارسات

| افعل | لا تفعل |
|------|--------|
| تحقق أن الإجمالي يطابق مبلغ البيع | قبول دفع جزئي بدون ترتيب |
| سجل أرقام المرجع للبطاقة/التحويل | تخطي أرقام المرجع |
| عد النقد المستلم بعناية | التسرع في عد النقد |
| احتفظ بسجلات الدفع للنزاعات | حذف سجلات الدفع |

---

## الميزة 3: برنامج ولاء العملاء

### ما هو؟

نظام الولاء يكافئ العملاء على مشترياتهم. العملاء يكسبون نقاطاً عند الشراء، ويستبدلون النقاط بخصومات على المشتريات المستقبلية. النظام يدعم المستويات (برونزي، فضي، ذهبي، بلاتيني) للعملاء المميزين.

### الفوائد الرئيسية

| الفائدة | الوصف |
|---------|-------|
| **الاحتفاظ بالعملاء** | النقاط تعطي العملاء سبباً للعودة |
| **زيادة المبيعات** | العملاء ينفقون أكثر لكسب/استخدام النقاط |
| **بيانات العملاء** | تتبع تاريخ الشراء والتفضيلات |
| **الميزة التنافسية** | تميز عن المنافسين بدون برامج ولاء |
| **التسويق المستهدف** | حدد وكافئ أفضل عملائك |

### متى تستخدم

| السيناريو | الإجراء |
|----------|---------|
| العميل يشتري | النقاط تُمنح تلقائياً |
| العميل يريد استبدال النقاط | طبق النقاط كخصم |
| عميل جديد يريد الانضمام | سجله في البرنامج |
| تشغيل عرض ترويجي | امنح نقاط إضافية |
| العميل يرجع منتجاً | النقاط تُعكس تلقائياً |

### حالة الاستخدام: بناء ولاء العملاء

**السيناريو:** مقهى يريد تشجيع الزيارات المتكررة.

**الإعداد:**
- اسم البرنامج: "مكافآت القهوة"
- الكسب: 1 نقطة لكل 1,000 دينار
- الاستبدال: كل نقطة قيمتها 100 دينار
- الحد الأدنى للاستبدال: 50 نقطة (قيمة 5,000 دينار)

**رحلة العميل:**
1. الزيارة الأولى: ينفق 25,000 دينار ← يكسب 25 نقطة
2. الزيارة الثانية: ينفق 30,000 دينار ← يكسب 30 نقطة (الإجمالي: 55)
3. الزيارة الثالثة: لديه 55 نقطة ← يستبدل 50 نقطة مقابل خصم 5,000 دينار

**النتيجة:** العميل وفر 5,000 دينار ومن المرجح أن يعود مرة أخرى.

### كيف تعمل النقاط

#### كسب النقاط

النقاط تُحسب تلقائياً بناءً على مبلغ الشراء:

```
النقاط المكتسبة = مبلغ الشراء × نقاط لكل عملة

مثال:
- نقاط لكل عملة: 0.01 (1 نقطة لكل 100 دينار)
- الشراء: 50,000 دينار
- النقاط المكتسبة: 50,000 × 0.01 = 500 نقطة
```

#### استبدال النقاط

النقاط تتحول إلى قيمة خصم:

```
قيمة الخصم = النقاط × عملة لكل نقطة

مثال:
- عملة لكل نقطة: 10 (كل نقطة = 10 دينار)
- النقاط للاستبدال: 500
- الخصم: 500 × 10 = 5,000 دينار خصم
```

#### نظام المستويات

العملاء يتقدمون عبر المستويات بناءً على النقاط الإجمالية:

| المستوى | النقاط الإجمالية | المزايا |
|---------|-----------------|---------|
| برونزي | 0+ | معدل الكسب الأساسي |
| فضي | 1,000+ | خدمة ذات أولوية |
| ذهبي | 5,000+ | نقاط إضافية في أعياد الميلاد |
| بلاتيني | 10,000+ | عروض حصرية |

### كيفية الاستخدام (خطوات الواجهة)

#### إعداد البرنامج

1. أنشئ برنامج ولاء (عادة مرة واحدة من المسؤول)
2. اضبط معدل الكسب (نقاط لكل عملة)
3. حدد قيمة الاستبدال (عملة لكل نقطة)
4. حدد الحد الأدنى للاستبدال
5. أعد المستويات (اختياري)

#### في نقطة البيع

**لكسب النقاط:**
1. اختر أو أنشئ العميل على البيع
2. عالج البيع بشكل عادي
3. النقاط تُحسب وتُمنح تلقائياً
4. الإيصال يعرض النقاط المكتسبة

**لاستبدال النقاط:**
1. اختر العميل (يجب أن يملك نقاطاً كافية)
2. انقر **استبدال النقاط** في الدفع
3. أدخل النقاط للاستبدال أو اختر المبلغ
4. الخصم يُطبق على البيع
5. أكمل الدفع

#### عرض حالة ولاء العميل

1. ابحث عن العميل في قائمة العملاء
2. اعرض لوحة الولاء:
   - رصيد النقاط الحالي
   - النقاط المكتسبة مدى الحياة
   - المستوى الحالي
   - قيمة النقاط (بالدينار)
   - تاريخ المعاملات

### كيفية الاستخدام (الكود)

```php
use App\Services\LoyaltyService;

$loyaltyService = app(LoyaltyService::class);

// تسجيل العميل في برنامج الولاء
$loyalty = $loyaltyService->enrollCustomer($customer);

// منح نقاط لبيع (عادة تلقائي)
$transaction = $loyaltyService->awardPointsForSale($sale);

// التحقق من حالة ولاء العميل
$summary = $loyaltyService->getCustomerSummary($customer);
// يعيد: enrolled, points_balance, lifetime_points, tier, points_value, can_redeem

// التحقق إذا كان العميل يمكنه الاستبدال
if ($loyaltyService->canRedeem($customer, 500)) {
    $value = $loyaltyService->calculateRedemptionValue($customer, 500);
    $transaction = $loyaltyService->redeemPoints($customer, 500, $sale);
}

// إضافة نقاط إضافية (عروض، أعياد ميلاد)
$loyaltyService->addBonusPoints($customer, 100, 'مكافأة عيد الميلاد');

// تعديل النقاط (تصحيحات)
$loyaltyService->adjustPoints($customer, -50, 'تصحيح لمنتج مرتجع');

// الحصول على تاريخ المعاملات
$history = $loyaltyService->getTransactionHistory($customer, limit: 20);

// الحصول على تقدم المستوى
$progress = $loyaltyService->getTierProgress($customer);
// يعيد: current_tier, next_tier, points_to_next_tier, progress_percentage

// عكس النقاط عند استرداد البيع
$loyaltyService->reverseSalePoints($sale);

// انتهاء صلاحية النقاط القديمة (تشغيل يومي عبر المجدول)
$expiredCount = $loyaltyService->expirePoints(daysOld: 365);
```

### أفضل الممارسات

| افعل | لا تفعل |
|------|--------|
| روّج للبرنامج لجميع العملاء | اجعل البرنامج سراً |
| اعرض رصيد النقاط على الإيصالات | اجعل الاستبدال معقداً |
| درّب الموظفين على كيفية عمل النقاط | دع النقاط تنتهي بصمت |
| امنح نقاطاً إضافية للعروض | اجعل كسب النقاط صعباً جداً |
| تتبع فعالية البرنامج | تجاهل معدلات المشاركة |

---

## الميزة 4: تعليق/استدعاء المبيعات

### ما هو؟

تعليق/استدعاء يسمح للكاشيرات بإيقاف بيع قيد التنفيذ واستئنافه لاحقاً. عناصر السلة ومعلومات العميل تُحفظ، ويمكن تحميلها مرة أخرى في نقطة البيع عند الجاهزية.

### الفوائد الرئيسية

| الفائدة | الوصف |
|---------|-------|
| **لا تخسر المبيعات** | العميل يمكنه الاستمرار في التسوق بدون خسارة السلة |
| **خدمة عملاء آخرين** | حرر الصندوق أثناء الانتظار |
| **تقليل الأخطاء** | العناصر تبقى في النظام، لا حاجة لإعادة المسح |
| **خدمة العملاء** | تتكيف مع العملاء الذين يحتاجون للمغادرة مؤقتاً |

### متى تستخدم

| السيناريو | الإجراء |
|----------|---------|
| العميل نسي محفظته، ذاهب للسيارة | علّق البيع، اخدم العميل التالي |
| العميل يريد إحضار المزيد من العناصر | علّق البيع، يستمر في التسوق |
| العميل يحتاج للتحقق مع شخص ما | علّق البيع، يجري اتصالاً |
| الدفع الطويل يحتاج موافقة المدير | علّق البيع، احصل على المدير |
| نهاية اليوم مع بيع غير مكتمل | المبيعات تنتهي تلقائياً بعد وقت محدد |

### حالة الاستخدام: العميل نسي المحفظة

**السيناريو:** العميل لديه عناصر بقيمة 50,000 دينار تم مسحها لكنه نسي محفظته في السيارة.

**الخطوات:**
1. الكاشير ينقر **تعليق البيع**
2. يضيف ملاحظة: "العميل يحضر المحفظة من السيارة"
3. يخدم العميل التالي في الطابور
4. العميل الأصلي يعود بعد 5 دقائق
5. الكاشير ينقر **المبيعات المعلقة** ← **استئناف**
6. جميع العناصر تُستعاد، يكمل البيع

**الفائدة:** لا عناصر ضائعة، لا إعادة مسح، الطابور يتحرك.

### كيفية الاستخدام (خطوات الواجهة)

#### تعليق بيع

1. أثناء وجودك في نقطة البيع مع عناصر في السلة
2. انقر زر **تعليق البيع**
3. اختيارياً أضف ملاحظة مرجعية (مثل "اسم العميل"، "السبب")
4. السلة تُحفظ وتُمسح
5. يمكنك الآن بدء بيع جديد

#### استدعاء بيع معلق

1. انقر زر **المبيعات المعلقة**
2. اعرض القائمة التي تظهر:
   - اسم العميل (إذا كان محدداً)
   - عدد العناصر
   - المبلغ الإجمالي
   - وقت التعليق
   - الملاحظات
3. انقر **استئناف** على البيع المطلوب
4. السلة تُستعاد بجميع العناصر
5. أكمل البيع بشكل عادي

#### إدارة المبيعات المعلقة

- المبيعات المعلقة تنتهي بعد 24 ساعة (قابل للتخصيص)
- احذف المبيعات المعلقة يدوياً إذا لم تعد مطلوبة
- اعرض من علّق البيع ومتى

### كيفية الاستخدام (الكود)

```php
use App\Models\HeldSale;

// تعليق بيع
$heldSale = HeldSale::create([
    'user_id' => auth()->id(),
    'customer_id' => $customerId,
    'cart_data' => $cartItems,
    'form_data' => $formData,
    'total_amount' => $total,
    'notes' => 'العميل يحضر المزيد من العناصر',
    'expires_at' => now()->addHours(24),
]);

// قائمة المبيعات المعلقة للمستخدم الحالي
$heldSales = HeldSale::active()
    ->forUser(auth()->user())
    ->latest()
    ->get();

// استئناف بيع معلق
$heldSale = HeldSale::find($id);
$cartData = $heldSale->cart_data;
$formData = $heldSale->form_data;

// حذف بعد الاستئناف الناجح
$heldSale->delete();

// تنظيف المبيعات المنتهية (تشغيل عبر المجدول)
HeldSale::where('expires_at', '<', now())->delete();
```

### أفضل الممارسات

| افعل | لا تفعل |
|------|--------|
| أضف ملاحظات وصفية | اترك الملاحظات فارغة |
| تحقق من المبيعات المعلقة قبل نهاية الوردية | دع المبيعات المعلقة تنتهي بلا داعٍ |
| استخدم للتأخيرات القصيرة فقط | استخدم كتخزين طلبات طويل الأمد |
| نظّف المعلقات المتروكة | دع المعلقات تتراكم |

---

## الميزة 5: طباعة الإيصالات

### ما هي؟

نظام الإيصالات ينشئ إيصالات احترافية بصيغ متعددة للعمل مع أي نوع طابعة - من طباعة المتصفح إلى طابعات الإيصالات الحرارية.

### الفوائد الرئيسية

| الفائدة | الوصف |
|---------|-------|
| **توافق شامل** | يعمل مع أي نوع طابعة |
| **مظهر احترافي** | إيصالات نظيفة مع العلامة التجارية |
| **صيغ متعددة** | HTML للمتصفح، ESC/POS للطابعات الحرارية |
| **قابلة للتخصيص** | إعداد الرأس، التذييل، ما يُعرض |
| **تكامل الولاء** | إظهار النقاط المكتسبة على الإيصال |

### متى تستخدم

| السيناريو | الصيغة |
|----------|--------|
| العميل يريد إيصالاً ورقياً | حراري (ESC/POS) أو متصفح (HTML) |
| إرسال إيصال بالبريد الإلكتروني | HTML |
| حفظ السجلات | أي صيغة |
| إيصالات الهدايا (بدون أسعار) | HTML مع تخصيص |

### صيغ الإخراج

| الصيغة | الأفضل لـ | الوصف |
|--------|----------|-------|
| **HTML** | طباعة المتصفح، البريد الإلكتروني | صيغة ويب قياسية |
| **نص خام** | طابعات النص فقط | نص عادي، عرض ثابت |
| **ESC/POS** | الطابعات الحرارية | أوامر قياسية صناعية |

### حالة الاستخدام: طباعة إيصال حراري

**السيناريو:** العميل يكمل الشراء، يحتاج إيصالاً مطبوعاً.

**العملية:**
1. البيع يكتمل
2. النظام ينشئ بيانات الإيصال
3. يحول إلى أوامر ESC/POS
4. يرسل للطابعة الحرارية
5. الإيصال يُطبع مع:
   - اسم وعنوان الشركة
   - التاريخ، الوقت، رقم الإيصال
   - العناصر مع الكميات والأسعار
   - تفصيل الضريبة
   - الإجمالي وطريقة الدفع
   - نقاط الولاء المكتسبة
   - رسالة الشكر
   - باركود للمرتجعات

### كيفية الاستخدام (الكود)

```php
use App\Services\ReceiptPrinterService;

$receiptService = app(ReceiptPrinterService::class);

// إعداد الإيصال (اختياري - يستخدم الافتراضيات إذا لم يُحدد)
$receiptService->setConfig([
    'business_name' => 'متجري',
    'paper_width' => 48,
    'footer_message' => 'شكراً لتسوقكم!',
    'show_tax_breakdown' => true,
    'show_loyalty_points' => true,
]);

// إنشاء بيانات الإيصال الكاملة
$receipt = $receiptService->generateReceipt($sale);

// الوصول لصيغ محددة
$html = $receipt['html'];
$text = $receipt['raw_text'];
$escpos = $receipt['escpos']['commands'];
$escposBase64 = $receipt['escpos']['base64'];

// أو إنشاء صيغ فردية
$html = $receiptService->generateHtml($sale);
$text = $receiptService->generateRawText($sale);
$escpos = $receiptService->generateEscPos($sale);
```

---

## المرجع التقني

### مخطط قاعدة البيانات

#### pos_sessions (جلسات نقطة البيع)

| العمود | النوع | الوصف |
|--------|------|-------|
| id | bigint | المفتاح الأساسي |
| user_id | bigint | معرف مستخدم الكاشير |
| terminal_id | string | معرف الطرفية |
| opening_time | timestamp | وقت بداية الوردية |
| closing_time | timestamp | وقت نهاية الوردية |
| opening_cash | decimal | مبلغ النقد الافتتاحي |
| closing_cash | decimal | المبلغ الختامي المعدود |
| expected_cash | decimal | النقد المتوقع المحسوب |
| cash_difference | decimal | مبلغ الزيادة/النقص |
| status | enum | open, closed, suspended |
| closed_by | bigint | المستخدم الذي أغلق الوردية |
| notes | text | ملاحظات الإغلاق |

#### sale_payments (مدفوعات المبيعات)

| العمود | النوع | الوصف |
|--------|------|-------|
| id | bigint | المفتاح الأساسي |
| sale_id | bigint | البيع الأصلي |
| pos_session_id | bigint | الجلسة المرتبطة |
| payment_method | string | نقد، بطاقة، إلخ. |
| amount | decimal | مبلغ الدفع |
| currency_id | bigint | العملة المستخدمة |
| exchange_rate | decimal | السعر المستخدم |
| reference_number | string | مرجع البطاقة/التحويل |
| tendered_amount | decimal | النقد المُعطى |
| change_amount | decimal | الباقي المُعاد |

#### held_sales (المبيعات المعلقة)

| العمود | النوع | الوصف |
|--------|------|-------|
| id | bigint | المفتاح الأساسي |
| user_id | bigint | الكاشير الذي علّق |
| customer_id | bigint | العميل (اختياري) |
| cart_data | json | عناصر السلة |
| form_data | json | حالة النموذج |
| total_amount | decimal | إجمالي السلة |
| notes | string | ملاحظات مرجعية |
| expires_at | timestamp | وقت الحذف التلقائي |

#### customer_loyalty (ولاء العملاء)

| العمود | النوع | الوصف |
|--------|------|-------|
| id | bigint | المفتاح الأساسي |
| customer_id | bigint | العميل |
| loyalty_program_id | bigint | البرنامج |
| points_balance | int | النقاط الحالية |
| lifetime_points | int | الإجمالي المكتسب |
| tier | string | المستوى الحالي |

---

## حل المشاكل

### الوردية لا تُفتح

**المشكلة:** لا أستطيع فتح وردية جديدة.

**الحلول:**
1. تحقق إذا كان لديك وردية مفتوحة (أغلقها أولاً)
2. تحقق من صلاحية `pos.access`
3. امسح الذاكرة المؤقتة: `php artisan optimize:clear`

---

### إجمالي الدفع المقسم لا يتطابق

**المشكلة:** بعد إضافة جميع المدفوعات، المبلغ المتبقي ليس صفراً.

**الحلول:**
1. تحقق من إدخال كل مبلغ دفع بشكل صحيح
2. تحقق من أسعار تحويل العملات إذا كنت تستخدم عملات متعددة
3. استخدم دالة التحقق قبل المعالجة

---

### نقاط الولاء لا تُمنح

**المشكلة:** العميل اشترى لكن لم يكسب نقاطاً.

**الحلول:**
1. تحقق أن العميل كان مربوطاً بالبيع
2. تحقق أن برنامج الولاء نشط
3. تأكد أن `points_per_currency` > 0 في إعدادات البرنامج
4. تحقق أن العميل مسجل في البرنامج

---

### الإيصال لا يُطبع

**المشكلة:** الإيصال لا يُطبع على الطابعة الحرارية.

**الحلول:**
1. تحقق أن الطابعة متصلة ومشغّلة
2. تحقق أن أوامر ESC/POS تتوافق مع موديل طابعتك
3. اختبر بصيغة النص الخام أولاً
4. تحقق من إعدادات اتصال الطابعة IP/USB

---

### البيع المعلق اختفى

**المشكلة:** بيع معلق لم يعد في القائمة.

**الحلول:**
1. تحقق إذا انتهت صلاحيته (الافتراضي: 24 ساعة)
2. مستخدم آخر قد استأنفه
3. شخص ما قد حذفه
4. تحقق من جدول held_sales مباشرة

---

*آخر تحديث: يناير 2026*
